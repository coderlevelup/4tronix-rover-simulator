<!DOCTYPE html>
<html>
<head>
    <title>Rover Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .main-container {
            display: flex;
            min-height: 100vh;
        }
        .camera-panel {
            flex: 0 0 50%;
            background-color: #f8f9fa;
            padding: 20px;
            border-right: 2px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        .camera-feed {
            flex: 1;
            margin-bottom: 20px;
        }
        .camera-feed:last-child {
            margin-bottom: 0;
        }
        .control-panel {
            flex: 1;
            padding: 20px;
        }
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 300px;
            margin: 20px auto;
        }
        .control-grid button {
            height: 80px;
        }
        .sequence-grid {
            display: grid;
            grid-template-columns: auto auto 100px;
            gap: 10px;
            max-width: 500px;
            margin: 20px auto;
        }
        .sequence-grid select {
            height: 40px;
        }
        .nav-tabs .nav-link {
            font-size: 1.2em;
            font-weight: bold;
        }
        .camera-container {
            text-align: center;
            margin: 20px auto;
            position: relative;
        }
        #camera-feed {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: #000;
        }
        .camera-title {
            text-align: center;
            margin-bottom: 20px;
            color: #495057;
        }
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .camera-panel {
                flex: none;
                border-right: none;
                border-bottom: 2px solid #dee2e6;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Camera Panel (Always Visible) -->
        <div class="camera-panel">
            <!-- Rover Mast Cam -->
            <div class="camera-feed">
                <h2 class="camera-title">Rover Mast Cam</h2>
                <div class="camera-container">
                    <video id="rover-camera-feed" autoplay muted playsinline style="width: 100%; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: rgb(30, 30, 30);"></video>
                    <div id="rover-camera-message" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; text-align: center; justify-content: center; font-size: 16px; font-weight: bold; color: white; pointer-events: none; padding: 20px; box-sizing: border-box; text-shadow: 0 0 5px black;">Connecting...</div>
                </div>
            </div>
            
            <!-- Satellite Cam -->
            <div class="camera-feed">
                <h2 class="camera-title">Satellite View</h2>
                <div class="camera-container">
                    <video id="satellite-camera-feed" autoplay muted playsinline style="width: 100%; max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: rgb(30, 30, 30);"></video>
                    <div id="satellite-camera-message" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; text-align: center; justify-content: center; font-size: 16px; font-weight: bold; color: white; pointer-events: none; padding: 20px; box-sizing: border-box; text-shadow: 0 0 5px black;">Connecting...</div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h1 class="text-center mb-4">Rover Control</h1>

        <!-- Navigation tabs -->
            <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual" type="button" role="tab">
                    Manual Control
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sequence-tab" data-bs-toggle="tab" data-bs-target="#sequence" type="button" role="tab">
                    Sequence Builder
                </button>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content mt-4">
            <!-- Manual Control Tab -->
            <div class="tab-pane fade show active" id="manual" role="tabpanel">
                <div class="control-grid">
                    <div></div>
                    <button class="btn btn-primary" onclick="sendCommand('forward')">Forward</button>
                    <div></div>
                    <button class="btn btn-primary" onclick="sendCommand('spin_left')">Spin Left</button>
                    <button class="btn btn-danger" onclick="sendCommand('stop')">Stop</button>
                    <button class="btn btn-primary" onclick="sendCommand('spin_right')">Spin Right</button>
                    <div></div>
                    <button class="btn btn-primary" onclick="sendCommand('backward')">Backward</button>
                    <div></div>
                </div>
            </div>

            <!-- Sequence Builder Tab -->
            <div class="tab-pane fade" id="sequence" role="tabpanel">
                <div class="sequence-grid">
                    <!-- Instruction 1 -->
                    <select class="form-select" id="cmd1">
                        <option value="">Select command...</option>
                        <option value="forward">Forward</option>
                        <option value="backward">Backward</option>
                        <option value="spin_left">Spin Left</option>
                        <option value="spin_right">Spin Right</option>
                    </select>
                    <select class="form-select" id="time1">
                        <option value="1">1 second</option>
                        <option value="2">2 seconds</option>
                        <option value="3">3 seconds</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearInstruction(1)">Clear</button>

                    <!-- Instructions 2-4 (repeat above pattern) -->
                    <select class="form-select" id="cmd2">
                        <option value="">Select command...</option>
                        <option value="forward">Forward</option>
                        <option value="backward">Backward</option>
                        <option value="spin_left">Spin Left</option>
                        <option value="spin_right">Spin Right</option>
                    </select>
                    <select class="form-select" id="time2">
                        <option value="1">1 second</option>
                        <option value="2">2 seconds</option>
                        <option value="3">3 seconds</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearInstruction(2)">Clear</button>

                    <select class="form-select" id="cmd3">
                        <option value="">Select command...</option>
                        <option value="forward">Forward</option>
                        <option value="backward">Backward</option>
                        <option value="spin_left">Spin Left</option>
                        <option value="spin_right">Spin Right</option>
                    </select>
                    <select class="form-select" id="time3">
                        <option value="1">1 second</option>
                        <option value="2">2 seconds</option>
                        <option value="3">3 seconds</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearInstruction(3)">Clear</button>

                    <select class="form-select" id="cmd4">
                        <option value="">Select command...</option>
                        <option value="forward">Forward</option>
                        <option value="backward">Backward</option>
                        <option value="spin_left">Spin Left</option>
                        <option value="spin_right">Spin Right</option>
                    </select>
                    <select class="form-select" id="time4">
                        <option value="1">1 second</option>
                        <option value="2">2 seconds</option>
                        <option value="3">3 seconds</option>
                    </select>
                    <button class="btn btn-secondary" onclick="clearInstruction(4)">Clear</button>
                </div>
                
                <div class="mt-3">
                    <button class="btn btn-success btn-lg" onclick="runSequence()">Run Sequence</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function sendCommand(cmd) {
            fetch(`/command/${cmd}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({speed: 100})
            }).then(response => response.json())
              .then(data => console.log(data))
              .catch(error => console.error('Error:', error));
        }

        function clearInstruction(num) {
            document.getElementById(`cmd${num}`).value = '';
            document.getElementById(`time${num}`).value = '1';
        }

        function runSequence() {
            const sequence = [];
            for (let i = 1; i <= 4; i++) {
                const cmd = document.getElementById(`cmd${i}`).value;
                const time = document.getElementById(`time${i}`).value;
                if (cmd) {
                    sequence.push({cmd, time});
                }
            }
            
            if (sequence.length === 0) {
                alert('Please add at least one instruction');
                return;
            }

            fetch('/sequence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({sequence})
            }).then(response => response.json())
              .then(data => console.log(data))
              .catch(error => console.error('Error:', error));
        }

        // WebRTC Camera Feed Implementation
        const retryPause = 2000;
        
        // Camera configurations
        const cameras = {
            rover: {
                video: document.getElementById('rover-camera-feed'),
                message: document.getElementById('rover-camera-message'),
                whepUrl: 'http://marspi.local:8889/cam/whep',
                pc: null,
                restartTimeout: null,
                sessionUrl: '',
                offerData: '',
                queuedCandidates: []
            },
            satellite: {
                video: document.getElementById('satellite-camera-feed'),
                message: document.getElementById('satellite-camera-message'),
                whepUrl: 'http://marsorbit.local:8889/cam/whep',
                pc: null,
                restartTimeout: null,
                sessionUrl: '',
                offerData: '',
                queuedCandidates: []
            }
        };
        
        let defaultControls = false;

        const setMessage = (camera, str) => {
            if (str !== '') {
                camera.video.controls = false;
            } else {
                camera.video.controls = defaultControls;
            }
            camera.message.innerText = str;
        };

        const unquoteCredential = (v) => (
            JSON.parse(`"${v}"`)
        );

        const linkToIceServers = (links) => (
            (links !== null) ? links.split(', ').map((link) => {
                const m = link.match(/^<(.+?)>; rel="ice-server"(; username="(.*?)"; credential="(.*?)"; credential-type="password")?/i);
                const ret = {
                    urls: [m[1]],
                };

                if (m[3] !== undefined) {
                    ret.username = unquoteCredential(m[3]);
                    ret.credential = unquoteCredential(m[4]);
                    ret.credentialType = 'password';
                }

                return ret;
            }) : []
        );

        const parseOffer = (offer) => {
            const ret = {
                iceUfrag: '',
                icePwd: '',
                medias: [],
            };

            for (const line of offer.split('\r\n')) {
                if (line.startsWith('m=')) {
                    ret.medias.push(line.slice('m='.length));
                } else if (ret.iceUfrag === '' && line.startsWith('a=ice-ufrag:')) {
                    ret.iceUfrag = line.slice('a=ice-ufrag:'.length);
                } else if (ret.icePwd === '' && line.startsWith('a=ice-pwd:')) {
                    ret.icePwd = line.slice('a=ice-pwd:'.length);
                }
            }

            return ret;
        };

        const enableStereoOpus = (section) => {
            let opusPayloadFormat = '';
            let lines = section.split('\r\n');

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('a=rtpmap:') && lines[i].toLowerCase().includes('opus/')) {
                    opusPayloadFormat = lines[i].slice('a=rtpmap:'.length).split(' ')[0];
                    break;
                }
            }

            if (opusPayloadFormat === '') {
                return section;
            }

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('a=fmtp:' + opusPayloadFormat + ' ')) {
                    if (!lines[i].includes('stereo')) {
                        lines[i] += ';stereo=1';
                    }
                    if (!lines[i].includes('sprop-stereo')) {
                        lines[i] += ';sprop-stereo=1';
                    }
                }
            }

            return lines.join('\r\n');
        };

        const editOffer = (offer) => {
            const sections = offer.sdp.split('m=');

            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                if (section.startsWith('audio')) {
                    sections[i] = enableStereoOpus(section);
                }
            }

            offer.sdp = sections.join('m=');
        };

        const generateSdpFragment = (od, candidates) => {
            const candidatesByMedia = {};
            for (const candidate of candidates) {
                const mid = candidate.sdpMLineIndex;
                if (candidatesByMedia[mid] === undefined) {
                    candidatesByMedia[mid] = [];
                }
                candidatesByMedia[mid].push(candidate);
            }

            let frag = 'a=ice-ufrag:' + od.iceUfrag + '\r\n'
                + 'a=ice-pwd:' + od.icePwd + '\r\n';

            let mid = 0;

            for (const media of od.medias) {
                if (candidatesByMedia[mid] !== undefined) {
                    frag += 'm=' + media + '\r\n'
                        + 'a=mid:' + mid + '\r\n';

                    for (const candidate of candidatesByMedia[mid]) {
                        frag += 'a=' + candidate.candidate + '\r\n';
                    }
                }
                mid++;
            }

            return frag;
        };

        const loadStream = (camera) => {
            requestICEServers(camera);
        };

        const onError = (camera, err) => {
            if (camera.restartTimeout === null) {
                console.error('WebRTC Error for', camera.whepUrl, ':', err);
                setMessage(camera, err + ', retrying in some seconds');

                if (camera.pc !== null) {
                    camera.pc.close();
                    camera.pc = null;
                }

                camera.restartTimeout = window.setTimeout(() => {
                    camera.restartTimeout = null;
                    loadStream(camera);
                }, retryPause);

                if (camera.sessionUrl) {
                    fetch(camera.sessionUrl, {
                        method: 'DELETE',
                    });
                }
                camera.sessionUrl = '';

                camera.queuedCandidates = [];
            }
        };

        const sendLocalCandidates = (camera, candidates) => {
            fetch(camera.sessionUrl + window.location.search, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/trickle-ice-sdpfrag',
                    'If-Match': '*',
                },
                body: generateSdpFragment(camera.offerData, candidates),
            })
                .then((res) => {
                    switch (res.status) {
                    case 204:
                        break;
                    case 404:
                        throw new Error('stream not found');
                    default:
                        throw new Error(`bad status code ${res.status}`);
                    }
                })
                .catch((err) => {
                    onError(camera, err.toString());
                });
        };

        const onLocalCandidate = (camera, evt) => {
            if (camera.restartTimeout !== null) {
                return;
            }

            if (evt.candidate !== null) {
                if (camera.sessionUrl === '') {
                    camera.queuedCandidates.push(evt.candidate);
                } else {
                    sendLocalCandidates(camera, [evt.candidate])
                }
            }
        };

        const onRemoteAnswer = (camera, sdp) => {
            if (camera.restartTimeout !== null) {
                return;
            }

            camera.pc.setRemoteDescription(new RTCSessionDescription({
                type: 'answer',
                sdp,
            }));

            if (camera.queuedCandidates.length !== 0) {
                sendLocalCandidates(camera, camera.queuedCandidates);
                camera.queuedCandidates = [];
            }
        };

        const sendOffer = (camera, offer) => {
            // Use correct WHEP endpoint
            fetch(camera.whepUrl + window.location.search, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/sdp',
                },
                body: offer.sdp,
            })
                .then((res) => {
                    switch (res.status) {
                    case 201:
                        break;
                    case 404:
                        throw new Error('stream not found');
                    default:
                        throw new Error(`bad status code ${res.status}`);
                    }
                    camera.sessionUrl = new URL(res.headers.get('location'), camera.whepUrl.replace('/whep', '')).toString();
                    return res.text();
                })
                .then((sdp) => onRemoteAnswer(camera, sdp))
                .catch((err) => {
                    onError(camera, err.toString());
                });
        };

        const createOffer = (camera) => {
            camera.pc.createOffer()
                .then((offer) => {
                    editOffer(offer);
                    camera.offerData = parseOffer(offer.sdp);
                    camera.pc.setLocalDescription(offer);
                    sendOffer(camera, offer);
                });
        };

        const onConnectionState = (camera) => {
            if (camera.restartTimeout !== null) {
                return;
            }

            if (camera.pc.iceConnectionState === 'disconnected') {
                onError(camera, 'peer connection disconnected');
            }
        };

        const onTrack = (camera, evt) => {
            setMessage(camera, '');
            camera.video.srcObject = evt.streams[0];
        };

        const requestICEServers = (camera) => {
            const url = camera.whepUrl + window.location.search;
            console.log('Requesting ICE servers from:', url);
            
            fetch(url, {
                method: 'OPTIONS',
            })
                .then((res) => {
                    console.log('ICE servers response status:', res.status);
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    
                    camera.pc = new RTCPeerConnection({
                        iceServers: linkToIceServers(res.headers.get('Link')),
                        sdpSemantics: 'unified-plan',
                    });

                    const direction = 'sendrecv';
                    camera.pc.addTransceiver('video', { direction });
                    camera.pc.addTransceiver('audio', { direction });

                    camera.pc.onicecandidate = (evt) => onLocalCandidate(camera, evt);
                    camera.pc.oniceconnectionstatechange = () => onConnectionState(camera);
                    camera.pc.ontrack = (evt) => onTrack(camera, evt);

                    createOffer(camera);
                })
                .catch((err) => {
                    console.error('ICE servers request failed:', err);
                    onError(camera, err.toString());
                });
        };

        const parseBoolString = (str, defaultVal) => {
            str = (str || '');

            if (['1', 'yes', 'true'].includes(str.toLowerCase())) {
                return true;
            }
            if (['0', 'no', 'false'].includes(str.toLowerCase())) {
                return false;
            }
            return defaultVal;
        };

        const loadAttributesFromQuery = () => {
            const params = new URLSearchParams(window.location.search);
            defaultControls = parseBoolString(params.get('controls'), true);
            
            // Set attributes for all cameras
            Object.values(cameras).forEach(camera => {
                camera.video.controls = defaultControls;
                camera.video.muted = parseBoolString(params.get('muted'), true);
                camera.video.autoplay = parseBoolString(params.get('autoplay'), true);
                camera.video.playsInline = parseBoolString(params.get('playsinline'), true);
            });
        };

        const init = () => {
            loadAttributesFromQuery();
            // Initialize both camera feeds
            loadStream(cameras.rover);
            loadStream(cameras.satellite);
        };

        // Initialize camera feeds when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
